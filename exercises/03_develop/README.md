# Developing the application

## Estimated time

:clock4: 20 minutes

## Objective

In this exercise you'll learn how you can develop the sample Product List application.

# Exercise description

We cloned the targeted version of the Product List application which you should develop by the end of the session, imported it in Eclipse and you can use it as a reference in case something doesn't work as expected during the exercises. Now it's time to start developing the Product List application - the goal is to go through the development starting from scratch, push the application to your trial account on SAP Cloud Platform Cloud Foundry Environment, explore what are the options to observe the application, enhance it to use different services.

## Create a Spring Boot Starter Project

- Eclipse -> File -> New -> Project -> Spring Boot -> Spring Starter Project
<br><br>
![Create Spring Starter Project](/img/spring_project_eclipse.png?raw=true)
<br><br>
- Click **Next** button
- On the next page fill in a name for the project e.g. my-product-list and click **Next** button
<br><br>
![Spring Starter Project Menu](/img/spring_project_eclipse_name.png?raw=true)
<br><br>
- Now you have to choose some Project Dependencies. In the search field type each dependency and select the check box in front of it to include it in the list of selected dependencies for the project: Actuator (Ops group), H2 (SQL group), JPA (SQL group), DevTools (Core group). You selected dependencies list should look like the screenshot below. Click **Finish** button and wait a minute until the project is created
<br><br>
![Dependencies](/img/spring_project_eclipse_dependencies.png?raw=true)
<br><br>
- You should now see it in the Project Explorer.
<br><br>
![Project Explorer my product list](/img/spring_project_explorer.png?raw=true)
<br><br>
- Build the project - right click in Project Explorer and select Run As -> Maven Build... and enter Goal *clean install*.
<br><br>
![Project Explorer my product list](/img/run_maven_build.png?raw=true)
<br><br>
Now we can continue with the application development steps.

## Product
- Right click on ```com.example.demo``` package --> new Class -> Create **class Product** in ```package com.example.demo```. We will use only this package for the sample application implementation.
- Annotate the class with ```@Entity``` (Right click on `Product.java` -> Source -> Organize imports -> `javax.persistence.Entity`) to indicate that this is a JPA Entity.  For lack of a @Table annotation, it is assumed that this entity will be mapped to a table named Product.
- Add the following **list of fields** for the Product. Annotate the id field with ```@Id and @GeneratedValue``` (Organize imports -> `javax.persistence.Id`, `javax.persistence.GeneratedValue`)
@Id specifies the primary key so that JPA will recognize it as the object’s id. The id property is also annotated with @GeneratedValue to indicate that the id (primary key) should be generated automatically. The other properties are left unannotated. It is assumed that they’ll be mapped to columns that share the same name as the properties themselves.
  ```java
	@Id
	@GeneratedValue
	private Long id;
	private String name;
	private String description;
	private BigDecimal price;
	private String currencyCode;
	private String pictureUrl;
  ```
  The imports should now be:
  ```java
	import java.math.BigDecimal;
	import javax.persistence.Entity;
	import javax.persistence.GeneratedValue;
	import javax.persistence.Id;
  ```
- Right click on `Product.java` -> Source -> Generate Getter and Setter. Select all fields except setter for id as it will be autogenerated.
- Generate constructors
  - Create constructor without fields (right click on the Product class -> Source -> Generate Constructor from Superclass...)
  - Create constructor using fields (right click on Product class -> Source -> Generate Constructor using Fields...).  Use all fields except id. Adjust the constructor definition such that String is provided as input parameter and it is converted to BigDecimal. We would have String coming from the UI, however we would like to stored it in numerical form in the database as primary key.
  - The constructors should now be:  
  ```java
  public Product() {
	}

	public Product(final String name, final String description, final String price, final String currencyCode,
			final String pictureUrl) {
		super();
		this.name = name;
		this.description = description;
		this.price = new BigDecimal(price);
		this.currencyCode = currencyCode;
		this.pictureUrl = pictureUrl;
	}
  ```
- **Override toString method** for convenient printing of the Product properties.
```java
@Override
	public String toString() {
		return "Product [id=" + id + ", name=" + name + ", description=" + description + ", price=" + price
				+ ", currencyCode=" + currencyCode + ", pictureUrl=" + pictureUrl + "]";
	}
```
We are done with the Product Entity and can continue with Product Repository.

## Product Repository
- Create an **interface ProductRepository** that **extends** `org.springframework.data.jpa.repository.JpaRepository` and works with Product entities. This interface helps us work with the Product entities. By extending JpaRepository, ProductRepository inherits several methods for working with Product persistence, including methods for saving, deleting, and finding Product entities.
```java
public interface ProductRepository extends JpaRepository<Product, String> {
}
```
Spring Data JPA also allows you to define other query methods by simply declaring their method signature. In the case of ProductRepository, this can be done with a `findByName()` method:
```java
public Collection<Product> findByName(String name);
```
(Source -> Organize imports -> `java.util.Collection`)
- Navigate to the application pom.xml file and add the following dependency
```Config
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-rest</artifactId>
</dependency>
```
- Annotate ProductRepository interface with ```@RepositoryRestResource```. (Organize imports - ```org.springframework.data.rest.core.annotation.RepositoryRestResource```). This indicates that at runtime, Spring Data REST will create an implementation of this interface automatically. Then it will use the @RepositoryRestResource annotation to direct Spring MVC to create RESTful endpoints.
- Initialize the database using Hibernate. Navigate to `src/main/resources/application.properties` file and add:
```Config
spring.jpa.hibernate.ddl-auto=create-drop
```
This means drop the old schema and create a new one. Of course, this is valid approach for development only, for productive usage you should integrate some schema management tool like e.g. Liquibase)

## Initialize with data
Now we need to initialize with some sample data, persist it and print it. We will do it adding the following code snippet to your application class that contains the main method to run the SpringBoot application. Navigate to the MyProductListApplication class (if your project name followed the example my-product-list this should be the name of the SpringBootApplication class) that was generated once you created the Spring Starter Project and add this code snippet:

```java
@Bean
	CommandLineRunner runner(final ProductRepository productRepo) {
		return strings -> {

			final List<Product> products = Arrays.asList(
					new Product("Notebook Basic 15",
							"Notebook Basic 15 with 1,7GHz - 15\" XGA - 1024MB DDR2 SDRAM - 40GB Hard Disc", "956.00",
							"EUR", "images/HT-1000.jpg"),
					new Product("Notebook Professional 15",
							"Notebook Professional 15 with 2,3GHz - 15\" XGA - 2048MB DDR2 SDRAM - 40GB Hard Disc - DVD-Writer (DVD-R/+R/-RW/-RAM)",
							"1999.00", "EUR", "images/HT-1010.jpg"),
					new Product("Ergo Screen",
							"17\" Optimum Resolution 1024 x 768 @ 85Hz, Max resolution 1280 x 960 @ 75Hz, Dot Pitch: 0.27mm",
							"230.00", "EUR", "images/HT-1030.jpg"));

			productRepo.save(products);

			productRepo.findAll().forEach(System.out::println);
		};
	}
```
After organizing the imports, the list of imported packages should look like this:
```java
import java.util.Arrays;
import java.util.List;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
```
Then the main() method of our application class uses Spring Boot’s SpringApplication.run() method to launch an application. It fetches the ProductRepository from the Spring application context. Then it saves a handful of Product objects, demonstrating the save() method and setting up some data to work with. Next, it calls findAll() to fetch all Customer objects from the database and prints them.

## (Optional) Create Controller
In Spring’s approach to building RESTful web services, HTTP requests are handled by a controller. These components are easily identified by the `@RestController` annotation.
- Create new **class Controller**
- Add annotation `@RestController` and include the following code snippet replacing class names where applicable:
```java
	@Autowired
	private ProductRepository productRepo;

	@GetMapping("/productsByParam")
	public Collection<Product> getProductByName(@RequestParam(value = "name") final String name) {
		return productRepo.findByName(name);
	}
```
After organizing imports, the imported packages for this class should look like:
```java
import java.util.Collection;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
```
- The controller receives requests from client, using repository to get data and return results.
The controller handles GET requests for /productsByParam by returning a collection of products based on name parameter.

## Create an UI
Let's add basic UI to our application using SAPUI5. The index.html we need is rather simple, but for the sake of saving time we won't ask you to implement it.
- Navigate to src/main/resources in the target application you cloned from github and copy the static folder where we have index.html and some images. Then paste it in your application project under src/main/resources.

## Build the project and run locally
- Right click on the project in the Project Explorer view -> Run as -> Maven build... -> goal: clean install
- Once the build is finished run locally the application: Right click on the project in the Project Explorer view -> Run as -> Spring Boot App

Now you can open a Chrome browser and see the application running on http://localhost:8080/

You should see a list of 3 products and when you click on a product get a dedicated product view with product description.

:bulb: **Note:** In case the default port 8080 that is used to run the application on localhost is occupied by another process, you can go to *application.properties* file in *src/main/resources* folder of the SprigBoot project and change it with the following property:
```Config
server.port=9090
```
